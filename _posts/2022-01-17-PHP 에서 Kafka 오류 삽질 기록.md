---
layout: post
title:  "PHP 에서 Kafka 오류 삽질 기록"
date:   2022-01-17 00:40:12
---

이게 아마 kafka dns 의 캐싱때문일꺼에요.

저희 프로듀싱할때도 retry되는 로직이 적용되어 있나요?

이게 주소 열거형이 아니라, dns 로 묶은 거라 쉽지 않을수도 있어요.

오류는 msk 메인터넌스 작업시 롤링을 진행되는 시간동안 간헐적으로 발생되었어고.


라우트53을 통해 재정의된 주소는 라운드로빈으로 단순 할당을 해주는데, 정작 그 브로커가 죽어 있으면 프로듀스던 컨슘이던 다 실패 합니다.
문제는 실패했다는걸 php가 바로 인지하지 못하는데요. 경우에 따라서 커넥션이 실패하면 다행히 재시도하면서 복구가 되지만, 커넥션은 정상으로 넘어갔다가 다른 작업에서 실패하는거면 그냥 멍때리는 경우가 생깁니다.
웃긴게 브로커 주소를 직접 다 넣으면 이런 증상이 없어집니다.
나중에 카프카 이중화를 위해서라도 라우트53을 통해 만든 주소를 써야 한다기에 중간에 카프카 상태를 확인할 수 있는 방법이 없는지 테스트 하다가…………리소스 부족으로 멈춘 상태 입니다 



대개 클러스터 도메인을 보고있기때문에 failover되어도 다시 연결 되어야 합니다. 전에도 maintance때 몇개 컨수머가 정상이 아니라서 확인요청은 드린것으로 제가 기억합니다

카프카에 최초 프로듀싱 하기전 각 파티션에 대한 리더의 위치에 대한 정보가 필요합니다.
해서 대표 URL(클러스터 url, Route 53)를 통해 반환되는 하나의 broker 에 접근하여 프로듀싱에 필요한 브로커 리스트(메타정보) 가져온뒤에 프로듀싱 하기 시작합니다.
즉 카프카 엔드포인트는 최초 프로듀싱 하기전 브로커 리스트를 가져오기 위한 접근을 위한 용도라고 보시면 됩니다.
메타 정보를 얻어온뒤로는 클러스터 엔드포인트(commerce.kafka.kurly.services)가 아닌
브로커 엔드포인트1:9092
브로커 엔드포인트2:9092
브로커 엔드포인트3:9092
와 같은 브로커로 직접 접근하면서 프로듀싱 하게 됩니다.
클러스터 엔드포인트와 장애는 크게 연결점이 없어 보입니다. 왜냐하면 이미 프로듀싱에 필요한 브로커 리스트를 클라이언트가 가지고 있기 때문입니다.
메인터넌스 작업때마다 드리는 말씀인거 같긴한데 개발망이나 스테이지 환경에서 브로커를 한대씩 죽여가며 테스트를 해보았으면 합니다. 정확히 어떤 에러가 어떤 타이밍에 발생하며 그러인해 설정값을 어떻게 가져가야 할지 알 수 있을듯합니다.


PHP 의 DNS Caching? 

<br><br>

_참고_

<br><br><br>
