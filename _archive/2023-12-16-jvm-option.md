---
layout: post
title:  "놓치기 쉬운 Jvm Options"
date:   2023-12-16 00:40:12
---

## 놓치기 쉬운 jvm options

서비스를 운영할 때 JVM option 을 통한 성능 튜닝을 하게 된다.

GC 알고리즘을 통해서 처리량(throughput)이나, 응답속도(response) 관점으로 나뉘어 선택하기도 하고, 메모리를 통해 GC 수행시간이나, 횟수를 통한 trade-off 를 선택하기도 한다.

Xmx, Xms, NewSize 등 기본적인 메모리 사이즈가 아닌 놓쳤던 옵션들이 있었다.

---

### InitialRAMPercentage

이 옵션은 JVM이 시작될 때 초기 힙 메모리 크기의 백분율입니다.

기본적으로 Java의 HotSpot JVM(Oracle)은 초기 힙 크기를 전체 힙 크기의 1/64로 설정하지만, 이 옵션이 50으로 설정되어 있다면, 초기 힙크기는 전체 메모리의 절반으로 설정됩니다.
(전체 시스템 메모리가 4GB이고 이 옵션이 50으로 설정되어 있다면 초기 힙 크기는 2GB가 된다.)

이 옵션은 Java 애플리케이션의 초기 힙 크기를 제어하여 성능과 메모리 사용을 조절하는 데 도움을 줍니다.

이렇게 함으로써 애플리케이션이 시작될 때 더 많은 메모리를 사용할 수 있게 됩니다. 
이는 초기에 메모리를 더 많이 할당하여 애플리케이션의 초기 부하를 줄일 수 있습니다. 
하지만 이로 인해 시스템 전체에서 사용 가능한 메모리가 부족할 수 있으므로 조심해서 사용해야 합니다.

---

### MaxRAMPercentage

JVM이 사용할 수 있는 최대 힙 메모리 크기의 백분율을 설정합니다.

기본적으로 HotSpot JVM은 최대 힙 크기를 전체 힙 크기의 1/4로 설정합니다.

예를 들어, 전체 시스템 메모리가 4GB이고 이 옵션이 50으로 설정되어 있다면 최대 힙 크기는 2GB입니다.

이 옵션을 사용하면 JVM이 시스템의 전체 메모리 중에서 얼마나 큰 부분을 사용할 수 있는지를 조절할 수 있습니다.

예를 들어, -XX:MaxRAMPercentage=50로 설정한다면 JVM은 전체 시스템 메모리의 50%까지만 최대 힙 크기로 사용할 수 있습니다. 
이렇게 함으로써 다른 프로세스나 시스템 서비스에 충분한 메모리를 확보할 수 있습니다. 
또한 이 옵션을 통해 JVM이 사용할 수 있는 메모리 양을 제한하여 시스템 리소스를 효율적으로 관리할 수 있습니다.

---

### MaxGCPauseMillis

가비지 컬렉션 (Garbage Collection)이 발생할 때 허용되는 최대 일시 중지 시간을 설정합니다.
이 값을 50으로 설정하면 가비지 컬렉션 중지 시간이 50밀리초를 넘지 않도록 노력합니다.

이 옵션에는 명시적인 기본값이 없으며, 기본적으로 최대 일시 중지 시간에 대한 목표를 설정하지 않습니다.

이 옵션은 가비지 컬렉션 (GC)이 발생할 때 허용되는 최대 일시 중지 시간을 설정합니다. 

작은 값으로 설정하면 GC가 더 빨리 완료되도록 하지만, 너무 작게 설정하면 GC가 빈번하게 발생할 수 있습니다. 이 값을 조절하여 애플리케이션의 응답 시간과 GC 성능 사이의 균형을 찾을 수 있습니다.

---

### UseStringDeduplication

문자열 중복 제거를 활성화합니다.

이 옵션을 사용하면 JVM은 메모리에서 동일한 문자열을 공유하여 중복을 피하려고 시도합니다.

일반적으로 이 옵션은 비활성화되어 있습니다.

이 옵션을 활성화하면 JVM은 문자열 중복을 감지하고 중복된 문자열을 공유하여 메모리를 절약합니다. 
이는 메모리 사용을 최적화하고 문자열 중복을 효과적으로 제거하여 애플리케이션의 메모리 효율성을 향상시킬 수 있습니다.

애플리케이션을 개발하다보면 동일한 String 문자열을 많이 생성하게 된다.

해당 옵션을 사용하면 중복되는 String 인스턴스들을 Global Single Char[]로 관리하여 힙 메모리의 사용을 최적화할 수 있다.

---

### FlightRecorder

Java Flight Recorder (JFR)를 활성화합니다.

JFR는 Java 애플리케이션의 실행 중에 발생하는 이벤트 및 트랜잭션 정보를 수집하고 분석하는 도구입니다. 애플리케이션 성능 프로파일링 및 디버깅에 유용합니다.

기본적으로 이 옵션은 비활성화되어 있습니다.

이 옵션을 활성화하면 약간의 오버헤드가 발생할 수 있으므로 프로덕션 환경에서 사용할 때 주의가 필요합니다.

-XX:StartFlightRecording=duration=60s,filename=myrecording.jfr 과 같은 옵션을 추가로 활용할 수 있습니다.


[2024-01 추가] JDK 17 에서 Deprecated 됨 
https://bugs.openjdk.org/browse/JDK-8225312
---

$RUN_JVM_PARAM \
-XX:InitialRAMPercentage=50 \
-XX:MaxRAMPercentage=50 \
-XX:MaxGCPauseMillis=50 \
-XX:+UseStringDeduplication \
-XX:+FlightRecorder \


_참고_
- https://sharplee7.tistory.com/61
- https://mangkyu.tistory.com/120
